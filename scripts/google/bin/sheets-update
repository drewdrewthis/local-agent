#!/bin/bash

# Google Sheets Update Script
# Updates the Marseille housing spreadsheet with data from La Carte des Colocs
#
# IMPORTANT: Run from project root (where .env file is located)
# Usage: ./scripts/google/bin/sheets-update [populate|read]
# Example: ./scripts/google/bin/sheets-update populate

set -euo pipefail

# Setup environment
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "$SCRIPT_DIR/../../.." && pwd)"
LIB_DIR="$SCRIPT_DIR/../lib"
source "$LIB_DIR/utils.sh"
source "$LIB_DIR/auth.sh"
source "$LIB_DIR/sheets.sh"

# Verify we're in the right directory
if [[ ! -f ".env" ]]; then
    echo "ERROR: .env file not found in current directory."
    echo "Please run this script from the project root directory (where .env is located)."
    echo "Example: ./scripts/google/bin/sheets-update"
    exit 1
fi

setup_environment

# Spreadsheet ID
SPREADSHEET_ID="1QYXsOTnYDSENkbYN9f5YzuQ8CE6BleWEpnRWIRsXvaA"
SHEET_NAME="Sheet1"

# Function to populate housing data
populate_housing_data() {
    log_info "Starting housing data population..."

    # Ensure we have a valid token
    ensure_valid_token

    # Housing data lives in vault (encrypted)
    local data_file="$PROJECT_ROOT/.vault/data/housing.json"
    if [[ ! -f "$data_file" ]]; then
        log_error "Housing data not found: $data_file"
        log_error "Run ./scripts/secrets/decrypt first"
        return 1
    fi

    local housing_data
    housing_data=$(cat "$data_file")
    local row_count
    row_count=$(echo "$housing_data" | jq '.values | length')

    # Update the sheet with housing data
    local range="${SHEET_NAME}!A1:P${row_count}"
    log_info "Updating sheet range: $range"

    local response
    response=$(sheets_update_values "$SPREADSHEET_ID" "$range" "$housing_data")

    if [ $? -eq 0 ]; then
        log_info "Successfully updated housing data in spreadsheet"
        echo "$response" | jq -r '.updatedRange // "Update completed"'
    else
        log_error "Failed to update spreadsheet"
        echo "$response"
        return 1
    fi
}

# Main function
main() {
    local action="${1:-populate}"

    case "$action" in
        "populate")
            populate_housing_data
            ;;
        "read")
            # Read current sheet data
            ensure_valid_token
            local range="${SHEET_NAME}!A1:Z100"
            local response
            response=$(sheets_get_values "$SPREADSHEET_ID" "$range")
            echo "$response" | jq '.'
            ;;
        *)
            log_error "Unknown action: $action"
            echo "Usage: $0 [populate|read]"
            return 1
            ;;
    esac
}

# Run main function with all arguments
main "$@"