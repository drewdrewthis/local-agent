#!/bin/bash
# Encrypt .vault directory as a single archive
# Usage: ./scripts/secrets/encrypt

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "$SCRIPT_DIR/../.." && pwd)"
VAULT_DIR="$PROJECT_ROOT/.vault"
ARCHIVE="$PROJECT_ROOT/.vault.tar.age"

if [[ ! -d "$VAULT_DIR" ]]; then
    echo "Error: .vault/ directory not found"
    exit 1
fi

# Collect files to archive
EXTRA_FILES=()
if [[ -f "$PROJECT_ROOT/.env" ]]; then
    EXTRA_FILES+=(".env")
fi

echo "=== Encrypting vault ==="
echo ""
echo "1. Zipping contents..."
echo "   - .vault/"
[[ ${#EXTRA_FILES[@]} -gt 0 ]] && echo "   - .env"

cd "$PROJECT_ROOT"

echo ""
echo "2. Encrypting archive..."
echo "   Enter passphrase:"
tar cf - .vault "${EXTRA_FILES[@]}" 2>/dev/null | age -e -p -o "$ARCHIVE"

echo ""
echo "3. Done!"
echo "   Created: .vault.tar.age ($(du -h "$ARCHIVE" | cut -f1))"
echo ""
echo "Ready to commit."
