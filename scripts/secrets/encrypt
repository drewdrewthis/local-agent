#!/bin/bash
# Encrypt sensitive files for git storage
# Usage: ./scripts/secrets/encrypt

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "$SCRIPT_DIR/../.." && pwd)"
VAULT_DIR="$PROJECT_ROOT/.vault"
SECRETS_DIR="$VAULT_DIR/secrets"

mkdir -p "$SECRETS_DIR"

# Files to encrypt (source -> encrypted destination)
FILES=(
    ".env:secrets/env.age"
    ".vault/context.md:secrets/context.md.age"
    ".vault/docs/budget-tracking.md:docs/budget-tracking.md.age"
    ".vault/docs/projects/storysnacks.md:docs/projects/storysnacks.md.age"
)

echo "Encrypting sensitive files..."
echo "You'll be prompted for a password (use the same one for all files)"
echo ""

for entry in "${FILES[@]}"; do
    src="${entry%%:*}"
    dest="${entry##*:}"

    src_path="$PROJECT_ROOT/$src"
    dest_path="$VAULT_DIR/$dest"

    # Create dest directory if needed
    mkdir -p "$(dirname "$dest_path")"

    if [[ -f "$src_path" ]]; then
        echo "Encrypting $src -> .vault/$dest"
        age -e -p -o "$dest_path" "$src_path"
    else
        echo "Skipping $src (not found)"
    fi
done

echo ""
echo "Done. Encrypted files are in .vault/"
echo "These can be safely committed to git."
