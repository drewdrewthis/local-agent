#!/bin/bash
# Decrypt sensitive files from git storage
# Usage: ./scripts/secrets/decrypt

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "$SCRIPT_DIR/../.." && pwd)"
VAULT_DIR="$PROJECT_ROOT/.vault"

if [[ ! -d "$VAULT_DIR" ]]; then
    echo "Error: .vault/ directory not found"
    echo "Make sure you've pulled the encrypted files from git"
    exit 1
fi

# Files to decrypt (encrypted source -> destination)
FILES=(
    "secrets/env.age:.env"
    "secrets/context.md.age:.vault/context.md"
    "docs/budget-tracking.md.age:.vault/docs/budget-tracking.md"
    "docs/projects/storysnacks.md.age:.vault/docs/projects/storysnacks.md"
)

echo "Decrypting sensitive files..."
echo "You'll be prompted for the password"
echo ""

for entry in "${FILES[@]}"; do
    src="${entry%%:*}"
    dest="${entry##*:}"

    src_path="$VAULT_DIR/$src"
    dest_path="$PROJECT_ROOT/$dest"

    # Create dest directory if needed
    mkdir -p "$(dirname "$dest_path")"

    if [[ -f "$src_path" ]]; then
        echo "Decrypting .vault/$src -> $dest"
        age -d "$src_path" > "$dest_path"
    else
        echo "Skipping $src (not found in .vault/)"
    fi
done

echo ""
echo "Done. Decrypted files are in place."
