#!/bin/bash
# Decrypt .vault archive
# Usage: ./scripts/secrets/decrypt

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "$SCRIPT_DIR/../.." && pwd)"
ARCHIVE="$PROJECT_ROOT/.vault.tar.age"

if [[ ! -f "$ARCHIVE" ]]; then
    echo "Error: .vault.tar.age not found"
    echo "Make sure you've pulled the encrypted archive from git"
    exit 1
fi

echo "=== Decrypting vault ==="
echo ""
echo "1. Decrypting archive..."
echo "   Source: .vault.tar.age ($(du -h "$ARCHIVE" | cut -f1))"
echo "   Enter passphrase:"

cd "$PROJECT_ROOT"
age -d "$ARCHIVE" | tar xf -

echo ""
echo "2. Unzipped contents:"
echo "   - .vault/"
[[ -f "$PROJECT_ROOT/.env" ]] && echo "   - .env"

echo ""
echo "3. Done!"
