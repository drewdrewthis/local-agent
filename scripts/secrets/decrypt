#!/bin/bash
# Decrypt sensitive files from git storage
# Usage: ./scripts/secrets/decrypt

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "$SCRIPT_DIR/../.." && pwd)"
SECRETS_DIR="$PROJECT_ROOT/secrets"

if [[ ! -d "$SECRETS_DIR" ]]; then
    echo "Error: secrets/ directory not found"
    echo "Make sure you've pulled the encrypted files from git"
    exit 1
fi

# Files to decrypt (encrypted name -> destination)
FILES=(
    "env.age:.env"
    "life-context.md.age:agent-notes/life-context.md"
)

echo "Decrypting sensitive files..."
echo "You'll be prompted for the password"
echo ""

for entry in "${FILES[@]}"; do
    src="${entry%%:*}"
    dest="${entry##*:}"

    if [[ -f "$SECRETS_DIR/$src" ]]; then
        echo "Decrypting secrets/$src -> $dest"
        age -d "$SECRETS_DIR/$src" > "$PROJECT_ROOT/$dest"
    else
        echo "Skipping $src (not found in secrets/)"
    fi
done

echo ""
echo "Done. Decrypted files are in place."
